<!DOCTYPE html>
<html>

<head>
    <title>用户列表</title>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <link href="${s.base}/media/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/style-responsive.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/light.css" rel="stylesheet" type="text/css"/>
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
 <link href="${s.base}/res/css/bootstrapValidator.min.css" rel="stylesheet" type="text/css">-->

    <link rel="icon" type="image/png" href="${s.base}/i/ico.png" sizes="16x16">
    <!-- BEGIN PAGE LEVEL STYLES -->
    <link href="${s.base}/res/css/plane.css" rel="stylesheet" type="text/css"/>
    <link href="${s.base}/media/css/style-metro.css" rel="stylesheet" type="text/css"/>

    <script src="${s.base}/media/js/jquery-1.10.1.min.js" type="text/javascript"></script>
    <script src="${s.base}/js/jquery.form.js" type="text/javascript"></script>
    <script src="${s.base}/media/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="${s.base}/media/js/app.js" type="text/javascript"></script>
    <script src="${s.base}/res/js/plane.js" type="text/javascript"></script>
    <script src="${s.base}/res/js/bootstrapValidator.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="${s.base}/res/js/jquery.md5.js"></script>
    <style>

        .inputfile {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .inputfile + label {
            font-size: 1.00em;
            font-weight: 600;
            display: inline-block;
            border-radius: 5px;
        }

        .inputfile + label {
            cursor: pointer; /* "hand" cursor */
        }

        .lf15px {
            left: 15px;
        }

        .controls button {
            margin: 20px 15px;
        }

        .help-block {
            color: red;
        }
    </style>
</head>
<body class="page-header-fixed">
<#include "common/header.html" />
<div class="page-container">
    <#include "common/nav.html" />

    <div class="page-content">
        <!-- BEGIN PAGE CONTAINER-->
        <div class="container-fluid">
            <!--  下面这块内容是在页面写死的  -->
            <!-- <h4 class="page-title">我的账号
                 <small>修改密码</small>
             </h4>-->
            <h4 class="page-title"></h4>

            <ul class="breadcrumb">
                <li>
                    <i class="icon-home"></i>
                    <a href="#">我的账号</a>
                    <i class="icon-angle-right"></i>
                </li>
                <li>
                    <a href="#">修改信息</a>
                    <i class="icon-angle-right"></i>
                </li>
                <li><a href="${s.base}/admin/passwordEdit">修改密码</a></li>
            </ul>
        </div>
        <!-- END PAGE TITLE & BREADCRUMB-->
        <div id="dashboard" style="min-height: 790px;">
            <!-- 填充内容 start-->
            <div class="container-fluid" style="width:92%;">
                <div class="row-fluid" style="margin:60px 30%;">
                    <div class="span12">
                        <div class="tabbable tabbable-custom">
                            <form method="post" id="passwordForm" role="form">

                                <div class="control-group form-group has-feedback">
                                    <label for="oldpassword" class="col-sm-2 control-label">账户名</label>
                                    <div class="controls form-control">
                                        <input type="text" class="m-wrap span4"
                                               name="username" id="username" value='${Session["login_user"].name}'
                                               disabled>
                                    </div>
                                </div>

                                <div class="control-group form-group has-feedback">
                                    <label for="oldpassword" class="col-sm-2 control-label">旧密码</label>
                                    <div class="controls form-control">
                                        <input type="password" class="m-wrap span4"
                                               name="oldpassword" id="oldpassword" placeholder="旧密码"> <span
                                            class="glyphicon glyphicon-lock form-control-feedback lf15px""></span>
                                    </div>
                                </div>

                                <div class="control-group form-group has-feedback">
                                    <label for="newpassword" class="col-sm-2 control-label">新密码</label>
                                    <div class="controls form-control">
                                        <input type="password" class="m-wrap span4"
                                               id="newpassword" name="password" placeholder="新密码"> <span
                                            class="glyphicon glyphicon-lock form-control-feedback lf15px"></span>
                                    </div>
                                </div>

                                <div class="control-group form-group has-feedback">
                                    <label for="newpasswordensure" class="col-sm-2 control-label">确认新密码</label>
                                    <div class="controls form-control">
                                        <input type="password" class="m-wrap span4"
                                               id="newpasswordensure" name="passwordensure" placeholder="新密码确认">
                                        <span
                                                class="glyphicon glyphicon-lock form-control-feedback  lf15px"></span>
                                    </div>
                                </div>

                                <div class="control-group form-group has-feedback">
                                    <div class="controls">
                                        <button type="reset" class="btn " id="restart">重置</button>
                                        <button type="button" class="btn green" id="modify">修改</button>
                                    </div>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="_ocDialogModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 id="myModalLabel1">消息提示</h4>
            </div>
            <div class="modal-body">
                <span style="font-size:1.2rem;" id="messageModify">密码修改成功！</span>
            </div>
            <div id="alertDiv"></div>
            <div class="modal-footer">
                <button class="btn blue" data-dismiss="modal" aria-hidden="true">关闭</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    jQuery(document).ready(function () {
        App.init();
    });
    // 初始化验证函数
    var validatorInit = function () {
        $("#passwordForm").bootstrapValidator({
                    live: 'enabled',//验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证
                    excluded: [':disabled', ':hidden', ':not(:visible)'],//排除无需验证的控件，比如被禁用的或者被隐藏的
                    submitButtons: '#modify',
                    //指定提交按钮，如果验证失败则变成disabled
                    message: '操作失败',//通用的验证失败消息
                    feedbackIcons: {//根据验证结果显示的各种图标
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        oldpassword: {
                            validators: {
                                notEmpty: {//检测非空,radio也可用
                                    message: '旧密码必须输入'
                                },
                                stringLength: {//检测长度
                                    min: 3,
                                    max: 12,
                                    message: '长度必须在6-12之间'
                                },
                                regexp: {//正则验证
                                    regexp: /^[a-zA-Z0-9_\.]+$/,
                                    message: '所输入的字符不符要求'
                                }

                            }

                        },
                        password: {
                            validators: {
                                // notEmpty: {//检测非空,radio也可用
                                //     message: '旧密码必须输入'
                                // },
                                stringLength: {//检测长度
                                    min: 3,
                                    max: 12,
                                    message: '长度必须在6-12之间'
                                },
                                regexp: {//正则验证
                                    regexp: /^[a-zA-Z0-9_\.]+$/,
                                    message: '所输入的字符不符要求'
                                }

                            }

                        },
                        passwordensure: {
                            validators: {
                                // notEmpty: {//检测非空,radio也可用
                                //     message: 'qure密码必须输入'
                                // },
                                stringLength: {//检测长度
                                    min: 3,
                                    max: 12,
                                    message: '长度必须在6-12之间'
                                },
                                regexp: {//正则验证
                                    regexp: /^[a-zA-Z0-9_\.]+$/,
                                    message: '所输入的字符不符要求'
                                },
                                identical: {
                                    field: 'password',
                                    message: '用户新密码与确认密码不一致！'
                                }
                            }
                        }
                    }
                }
        );

    }


    $("#modify").on("click", function () {
        //获取表单对象
        var bootstrapValidator = $('#passwordForm').data('bootstrapValidator');
        //手动触发验证
        bootstrapValidator.validate();
        if (bootstrapValidator.isValid()) {

        	 var user = $('#username').val();
        	 var oldpwd = $('#oldpassword').val();
             var newpwd = $('#newpassword').val();
             var oldmd5Pwd=$.md5(user + oldpwd);
             var newmd5Pwd = $.md5(user + newpwd);
                 
             $.ajax({
            	   type: 'POST',
                   url: '${s.base}/admin/doPasswordEdit.action',
                   dataType: 'json',
                   data: {
                   	'oldpassword':oldmd5Pwd,
                   	'password':newmd5Pwd
                   },
                   success: function (result) {
                       $("#messageModify").text(result.message);
                       Modal.show('_ocDialogModal');
                   }, error: function () {
                       $("#messageModify").text("出错了，请重试!");
                       Modal.show('_ocDialogModal');
                   }
             });
        }

    });

    // 页面载入时,初始化验证方法
    $(function () {
        var onValidatorInit = new validatorInit();
    });
    // 重置操作
    $("#restart").click(function () {
        $("#passwordForm").data('bootstrapValidator').destroy();
        $("#passwordForm").data('bootstrapValidator', null);
        var onValidatorInit = new validatorInit();
    });
</script>
</body>
</html>