<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>机器人智能巡检系统</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="" name="description"/>
    <meta content="" name="author"/>

    <!--<#include "common/res.html" />-->
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="media/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/style-responsive.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/light.css" rel="stylesheet" type="text/css"/>
    <link rel="icon" type="image/png" href="${s.base}/i/ico.png" sizes="16x16">

    <link href="media/css/style-metro.css" rel="stylesheet" type="text/css"/>
    <link href="media/css/uniform.default.css" rel="stylesheet" type="text/css"/>

    <!-- BEGIN PAGE LEVEL STYLES -->
    <link href="media/css/glyphicons.css" rel="stylesheet"/>
    <link href="media/css/halflings.css" rel="stylesheet"/>
    <link href="media/css/search.css" rel="stylesheet"/>
    <!-- END PAGE LEVEL STYLES -->

    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.4.6&key=82f9e75505b649be9ab81a45ae34aa14"></script>
    <link rel="stylesheet" href="${s.base}/res/css/common.css">
    <!-- 全局搜索的css -->
	<link rel="stylesheet" href="${s.base}/res/css/main-search.css">	
</head>
<body class="page-header-fixed">
<#include "common/header.html" />
<div class="page-container">
    <#include "common/nav.html" />
    <!-- BEGIN PAGE -->

    <div class="page-content">
        <!-- BEGIN PAGE CONTAINER-->
        <div class="container-fluid">

            <h4 class="page-title"></h4>
            <ul class="breadcrumb" style="margin-bottom:10px;">
                <li>
                    <i class="icon-home"></i>
                    <a href="index.html">机器人智能巡检系统</a>
                    <i class="icon-angle-right"></i>
                </li>
                <li><a href="${s.base}/home.action">主页</a></li>
            </ul>



        </div>
        <!-- END PAGE HEADER-->
        <div id="dashboard">
            <div id="container">
            </div>

            <script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
            <script type="text/javascript">

                var planePath =${flyingPath};
                var centerpoint;
                if (planePath.length > 0 && planePath[0].pathdata[0] != null) {
                    centerpoint = planePath[0].pathdata[0];
                } else {
                    centerpoint = [114.434805,30.511269];
                }
                centerpoint = [114.434805,30.511269];
                //创建一个地图
                var map = new AMap.Map('container', {
                    resizeEnable: true,
                    center: centerpoint,
                    zoom: 15
                });

                map.plugin(["AMap.ToolBar", "AMap.Scale"], function () {
                    var scale = new AMap.Scale({          //生成 比例尺插件
                        visible: true,
                        position: 'LB',
                    });
                    map.addControl(scale);
                    scale.show();
                    map.addControl(new AMap.ToolBar());    //生成 比例尺滚动条
                });
                if (location.href.indexOf('&guide=1') !== -1) {
                    map.setStatus({scrollWheel: false})
                }
                AMapUI.loadUI(['control/BasicControl'], function (BasicControl) {

                    var layerCtrl1 = new BasicControl.LayerSwitcher({
                        position: 'rb',
                    });
                    map.addControl(layerCtrl1);
                });

                var infoWindow = new AMap.InfoWindow({
                    isCustom: true,
                    offset: new AMap.Pixel(20, -35)
                });

                //
                // for(var j=0;j<planePath.length;j++){
                //     var polyline = new AMap.Polyline({
                //         map: map,
                //         path: planePath[j].pathdata, //设置线覆盖物路径
                //         strokeColor: '#ff6700', //线颜色
                //         strokeOpacity: 1, //线透明度
                //         strokeWeight: 3, //线宽
                //         strokeStyle: "solid", //线样式
                //         strokeDasharray: [10, 5] //补充线样式
                //     });
                // }

                var alarmList = ${alarmList!};
                AMapUI.loadUI(['overlay/SimpleMarker'], function (SimpleMarker) {

                    if (alarmList.length == 0 || alarmList == null) {
                        //alert("没有告警数据！");
                    } else {
                        for (var i = 0; i < alarmList.length; i++) {

                            //启动页面
                            var dangerPoint = new SimpleMarker({
                                //前景文字
                                iconLabel: {
                                    innerHTML: '<i>危</i>', //设置文字内容
                                    style: {
                                        color: 'white' //设置文字颜色
                                    }
                                },
                                //图标主题
                                iconTheme: 'default',
                                //背景图标样式
                                iconStyle: 'red',
                                //...其他Marker选项...，不包括content
                                map: map,
                                position: alarmList[i].position,
                            });

                            var title = '告警点编号：<span>' + alarmList[i].id + '</span>';
                            var content = [];

                            content.push("创建时间：" + alarmList[i].createTime);
                            content.push("飞行任务名称：" + alarmList[i].taskName);
                            content.push("飞行路径：" + alarmList[i].flyingPathName);
                            content.push("信息点：" + alarmList[i].infoName);
                            content.push("描述：" + alarmList[i].descripte);
                            content.push("创建者：" + alarmList[i].userCreatorName)
                            content.push("放飞员：" + alarmList[i].userAName);
                            content.push("降落员：" + alarmList[i].userZName);
                            content.push("无人机名称：" + alarmList[i].uavName);
                            content.push("无人机设备编号：" + alarmList[i].uavDeviceId);
                            content.push("<img src=" + alarmList[i].image + " class='alarmImg'>");
                            dangerPoint.content = createInfoWindow(title, content.join("<br/>"));
                            dangerPoint.on('click', markerClick);

                        }
                    }

                });

                /*        AMapUI.load(['ui/misc/PointSimplifier', 'lib/$'], function (PointSimplifier, $) {
                            if (!PointSimplifier.supportCanvas) {
                                alert('当前环境不支持 Canvas！');
                                return;
                            }
                            var pointSimplifierIns = new PointSimplifier({
                                zIndex: 115,
                                autoSetFitView: false,
                                map: map, //所属的地图实例

                                getPosition: function (item) {
                                    if (!item) {
                                        return null;
                                    }

                                    return item;
                                    // var parts = item.split(',');
                                    // return [parseFloat(parts[0]), parseFloat(parts[1])];
                                },
                                //使用GroupStyleRender
                                renderConstructor: PointSimplifier.Render.Canvas.GroupStyleRender,
                                renderOptions: {
                                    eventSupport: false, //禁止事件,对性能更友好
                                    //点的样式
                                    pointStyle: {
                                        fillStyle: null,
                                        width: 5,
                                        height: 5
                                    },
                                    topNAreaStyle: null,
                                    getGroupId: function (item, idx) {

                                        //随机返回一个组ID
                                        return Math.ceil(4 * Math.random());
                                    },
                                    groupStyleOptions: function (gid) {
                                        //随机设置大小
                                        var radius = 10 + 10 * Math.random();
                                        return {

                                            pointStyle: radius > 0 ? {
                                                content: function (ctx, x, y, width, height) {

                                                    var p = {
                                                        x: x + width / 2,
                                                        y: y + height / 2,
                                                        radius: radius
                                                    };

                                                    ctx.beginPath();
                                                    var gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
                                                    gradient.addColorStop(0, "rgba(255,0,0,1)");
                                                    gradient.addColorStop(1, "rgba(255,0,0,0.1)");
                                                    ctx.fillStyle = gradient;
                                                    ctx.arc(p.x, p.y, p.radius, Math.PI * 2, false);
                                                    ctx.fill();

                                                },

                                                //fillStyle: colors[gid % colors.length],
                                                width: radius * 2,
                                                height: radius * 2
                                            } : null,
                                            pointHardcoreStyle: {
                                                width: radius * 2 + 3,
                                                height: radius * 2 + 3
                                            }
                                        };
                                    }

                                }
                            });
                            //重复render
                            setInterval(function () {
                                pointSimplifierIns.render();
                            }, 500)

                            var data = new Array();
                            if(alarmList.length>0){
                                for(var i=0;i<alarmList.length;i++){
                                    data[i] = alarmList[i].position;
                                }
                                pointSimplifierIns.setData(data);
                            }
                        });
                        */
                //构建自定义信息窗体
                function createInfoWindow(title, content) {
                    var info = document.createElement("div");
                    info.className = "info";

                    //可以通过下面的方式修改自定义窗体的宽高
                    //info.style.width = "400px";
                    // 定义顶部标题
                    var top = document.createElement("div");
                    var titleD = document.createElement("div");
                    var closeX = document.createElement("img");
                    top.className = "info-top";
                    titleD.innerHTML = title;
                    closeX.src = "res/i/close2.gif";
                    closeX.onclick = closeInfoWindow;

                    top.appendChild(titleD);
                    top.appendChild(closeX);
                    info.appendChild(top);

                    // 定义中部内容
                    var middle = document.createElement("div");
                    middle.className = "info-middle";
                    middle.style.backgroundColor = 'white';
                    middle.innerHTML = content;
                    info.appendChild(middle);
                    return info;
                }

                //打开信息窗体
                function markerClick(e) {
                    infoWindow.setContent(e.target.content);
                    infoWindow.open(map, e.target.getPosition());
                }

                //关闭信息窗体
                function closeInfoWindow() {
                    map.clearInfoWindow();
                }

            </script>

        </div>
    </div>
    <!-- END PAGE CONTAINER-->
</div>

<!-- END PAGE -->

<script src="media/js/jquery-1.10.1.min.js" type="text/javascript"></script>
<script src="media/js/bootstrap.min.js" type="text/javascript"></script>
<script src="media/js/app.js" type="text/javascript"></script>
 <!-- 全局搜索的js -->
<script src="${s.base}/res/js/search.js" type="text/javascript"></script>
<script>
    jQuery(document).ready(function () {
        App.init();       
    });
</script>
</body>
</html>